# .bashrc for user smilart

PATH_CONTAINERS="/var/lib/smilart_srv/repos/*";
PATH_CONFIGURE_DIR="/etc/smilart";

function wait_func(){
local TIMEOUT=$1;
echo -n "Wait -- ";
while [ $TIMEOUT -gt 0 ]; do
  echo -n "$TIMEOUT ";
  TIMEOUT=$(($TIMEOUT-1));
  sleep 1;
  echo -n $'\177';
  echo -n $'\177';
done;
echo "OK";
}

if [[ $- =~ "i" && $USER == "smilart" ]]; then

  sudo setterm -msg off;

  sudo mkdir -p $PATH_CONFIGURE_DIR;
  if [ ! -e $PATH_CONFIGURE_DIR/first_boot ]; then

    #Configuring network
    if [ ! -e $PATH_CONFIGURE_DIR/network_installed ]; then
        network-config;
        if [[ $? == 0 ]];then
            touch $PATH_CONFIGURE_DIR/network_installed;
        else
            echo;
            echo -e "\E[33mWARN: Network is not configured.";tput sgr0;
            sleep 1;
        fi;
    fi;

    #Configuring time
    if [ ! -e $PATH_CONFIGURE_DIR/datetime_installed ]; then
        datetime-config;
        if [[ $? == 0 ]];then
            touch $PATH_CONFIGURE_DIR/datetime_installed;
        else
            echo;
            echo -e "\E[33mWARN: Time is not configured.";tput sgr0;
            sleep 1;
        fi;
    fi;

    #Configuring cluster
    if [ ! -e $PATH_CONFIGURE_DIR/cluster_installed ]; then
        cluster-config;
        if [[ $? == 0 ]];then
            touch $PATH_CONFIGURE_DIR/cluster_installed;
        else
            echo;
            echo -e "\E[33mWARN: Cluster is not configured.";tput sgr0;
            sleep 1;
        fi;
    fi;

    #Loading containers
    for LIST_CONTAINERS in $PATH_CONTAINERS; do
        echo;
        echo "Processing $LIST_CONTAINERS file...";
        sudo /usr/sbin/sam installfile $LIST_CONTAINERS;
    done;
    
    #Installing product
    if [ ! -e $PATH_CONFIGURE_DIR/product_installed ]; then
        touch $PATH_CONFIGURE_DIR/product_installed;
        sudo /opt/bin/installproduct;
        if [ $? -ne 0 ];then
            echo -e "\E[31mERROR: Product is not installed correctly." >&2;tput sgr0;
        else
            echo -e "\E[32mInstallation is completed.";tput sgr0;
        fi;
    fi;

    # Rebooting system
    echo -e "\E[33mSystem will reboot after 15 seconds.";tput sgr0;
    wait_func 15;
    sudo /sbin/reboot;

  fi;
fi;

unset PATH_CONTAINERS;
unset LIST_CONTAINERS;
